// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}


// --- Enums ---

/// Defines whether a story is pre-built or dynamically generated.
enum StoryType {
  STATIC     // Human-built, uses Scenes and Decisions.
  DYNAMIC_AI // AI-generated, uses the PlaythroughLog.
}

enum Role {
  USER
  AUTHOR
  ADMIN
}

// --- ADDED: Language Enum ---
/// Defines the supported languages for content.
enum Language {
  EN
  ES
}


// --- CORE TABLES ---

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  firstName     String
  lastName      String?
  userName      String?   @unique
  languagePref  Language  @default(EN)
  role          Role     @default(USER)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  author        Author?
  playthroughs  Playthrough[]
}

model Author {
  id     String @id @default(uuid())
  // --- REMOVED: name, bio are now in AuthorTranslation ---
  // name   String
  // bio    String?

  // Relation to User (1-to-1, nullable for system/AI authors)
  userId String? @unique
  user   User?   @relation(fields: [userId], references: [id])

  // Relations
  chronicles   Chronicle[]
  images       Image[]
  // --- ADDED: Relation to translations ---
  translations AuthorTranslation[]
}

// --- ADDED: Translation table for Author ---
model AuthorTranslation {
  name String
  bio  String?

  // Foreign Keys & Composite Primary Key
  authorId String
  language Language
  author   Author   @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@id([authorId, language])
}


// --- CONTENT DEFINITION TABLES ---

model Chronicle {
  id            String    @id @default(uuid())
  // --- REMOVED: title, description are now in ChronicleTranslation ---
  // title         String
  // description   String    @db.Text
  coverImageUrl String
  type          StoryType
  isPublished   Boolean   @default(false)
  createdAt     DateTime  @default(now())

  // Foreign Keys
  authorId      String
  author        Author    @relation(fields: [authorId], references: [id])

  // Starting Scene (Only for STATIC stories)
  startSceneId  String?   @unique
  startScene    Scene?    @relation("StartScene", fields: [startSceneId], references: [id])

  // Relations
  scenes        Scene[]
  playthroughs  Playthrough[]
  // --- ADDED: Relation to translations ---
  translations  ChronicleTranslation[]
}

// --- ADDED: Translation table for Chronicle ---
model ChronicleTranslation {
  title       String
  description String @db.Text

  // Foreign Keys & Composite Primary Key
  chronicleId String
  language    Language
  chronicle   Chronicle @relation(fields: [chronicleId], references: [id], onDelete: Cascade)

  @@id([chronicleId, language])
}

model Image {
  id            String  @id @default(uuid())
  url           String  @unique
  // --- REMOVED: altText is now in ImageTranslation ---
  // altText       String?
  isAiGenerated Boolean @default(false)

  // Relation to Author
  authorId      String?
  author        Author? @relation(fields: [authorId], references: [id])

  // Relations
  scenes       Scene[]
  // --- ADDED: Relation to translations ---
  translations ImageTranslation[]
}

// --- ADDED: Translation table for Image ---
model ImageTranslation {
  altText String?

  // Foreign Keys & Composite Primary Key
  imageId  String
  language Language
  image    Image @relation(fields: [imageId], references: [id], onDelete: Cascade)

  @@id([imageId, language])
}


// --- STATIC STORY STRUCTURE (Node-Graph) ---

model Scene {
  id      String @id @default(uuid())
  // --- REMOVED: content is now in SceneTranslation ---
  // content String @db.Text

  // Foreign Keys
  chronicleId String
  chronicle   Chronicle @relation(fields: [chronicleId], references: [id], onDelete: Cascade)

  imageId   String?
  image     Image?    @relation(fields: [imageId], references: [id])

  // Relations (Branching)
  outgoingDecisions Decision[] @relation("FromScene")
  incomingDecisions Decision[] @relation("ToScene")

  // Relations for Playthrough Tracking
  currentPlaythroughs Playthrough[]
  isStartingSceneFor  Chronicle?     @relation("StartScene")
  // --- ADDED: Relation to translations ---
  translations        SceneTranslation[]
}

// --- ADDED: Translation table for Scene ---
model SceneTranslation {
  content String @db.Text

  // Foreign Keys & Composite Primary Key
  sceneId  String
  language Language
  scene    Scene @relation(fields: [sceneId], references: [id], onDelete: Cascade)

  @@id([sceneId, language])
}

model Decision {
  id    String @id @default(uuid())
  // --- REMOVED: text is now in DecisionTranslation ---
  // text  String

  // Advanced Personalization Logic
  conditions Json?
  actions    Json?

  // Foreign Keys (Defines the link)
  fromSceneId String
  fromScene   Scene  @relation("FromScene", fields: [fromSceneId], references: [id], onDelete: Cascade)

  toSceneId   String
  toScene     Scene  @relation("ToScene", fields: [toSceneId], references: [id], onDelete: Cascade)

  // --- ADDED: Relation to translations ---
  translations DecisionTranslation[]
}

// --- ADDED: Translation table for Decision ---
model DecisionTranslation {
  text String

  // Foreign Keys & Composite Primary Key
  decisionId String
  language   Language
  decision   Decision @relation(fields: [decisionId], references: [id], onDelete: Cascade)

  @@id([decisionId, language])
}


// --- PLAYTHROUGH TABLES (User Game State) ---

model Playthrough {
  id             String    @id @default(uuid())
  startedAt      DateTime  @default(now())
  completedAt    DateTime?
  currentState   Json

  // Foreign Keys
  userId         String
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  chronicleId    String
  chronicle      Chronicle @relation(fields: [chronicleId], references: [id], onDelete: Cascade)

  currentSceneId String?
  currentScene   Scene?    @relation(fields: [currentSceneId], references: [id])

  // Logs for DYNAMIC_AI stories
  aiLogs PlaythroughLogAI[]
}

model PlaythroughLogAI {
  id                String   @id @default(uuid())
  order             Int
  generatedContent  String   @db.Text
  generatedImageUrl String?
  userInput         String   @db.Text
  createdAt         DateTime @default(now())
  // --- ADDED: Language of this specific interaction ---
  language          Language

  // Foreign Key
  playthroughId     String
  playthrough       Playthrough @relation(fields: [playthroughId], references: [id], onDelete: Cascade)

  @@index([playthroughId, order])
}
